<!DOCTYPE html>
<html lang="">

<head><meta name="generator" content="Hexo 3.8.0">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1.0, user-scalable=no">

    
      <link rel="icon" href="/note/shell.png">
    

    <title>
        
          PBR - kaiiiz/note
        
    </title>

    <!-- Spectre.css framework (v0.5.8) -->
    <link rel="stylesheet" href="https://unpkg.com/spectre.css/dist/spectre.min.css">
    <link rel="stylesheet" href="https://unpkg.com/spectre.css/dist/spectre-exp.min.css">
    <link rel="stylesheet" href="https://unpkg.com/spectre.css/dist/spectre-icons.min.css">

    <!-- Noto Sans TC -->
    <link href="https://fonts.googleapis.com/css?family=Noto+Sans+TC" rel="stylesheet">

    <!-- theme css & js -->
    <link rel="stylesheet" href="/note/css/spectre_custom.css">
    <link rel="stylesheet" href="/note/css/book.css">
    <script src="/note/js/book.js"></script>

    <!-- tocbot -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tocbot/4.4.2/tocbot.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/tocbot/4.4.2/tocbot.css">

    <!-- highlight.js -->
    <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.15.6/styles/default.min.css">
    <script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.15.6/highlight.min.js"></script>
    <script>hljs.initHighlightingOnLoad();</script>
    
    <!-- katex -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.10.0/katex.min.css">

    
<!-- Google Analytics -->
<script>
(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
})(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

ga('create', 'UA-112717568-2', 'auto');
ga('send', 'pageview');
</script>
<!-- End Google Analytics -->

</head>

<body>

<div class="container">
  <div class="book-container">
    <div class="columns">
      <div class="column col-2 hide-lg">
        <div class="book-sidebar">
  <h4 class="site-meta">
    <a href="/note/">kaiiiz/note</a>
  </h4>
  <div class="sidebar-content">
    <ul>
<li><a href="/note">首頁</a></li>
<li><a href="/note/1072/sophomore">大二</a></li>
<li>大三</li>
<li>大四</li>
<li>英語相關
<ul>
<li><a href="/note/english-learning/grammar">文法</a></li>
</ul>
</li>
<li>網路相關
<ul>
<li><a href="/note/network-associate/landesign">LAN Design</a></li>
<li>Layer 2
<ul>
<li><a href="/note/network-associate/layer2/vlan">VLAN</a></li>
<li><a href="/note/network-associate/layer2/vtp">VTP</a></li>
<li><a href="/note/network-associate/layer2/stp">STP</a></li>
</ul>
</li>
<li>Layer 3
<ul>
<li><a href="/note/network-associate/layer3/routing">Routing</a></li>
<li><a href="/note/network-associate/layer3/vlsm">VLSM</a></li>
<li><a href="/note/network-associate/layer3/ospf">OSPF</a></li>
<li><a href="/note/network-associate/layer3/redistribution">Redistribution</a></li>
<li><a href="/note/network-associate/layer3/packet-switching">Packet Switching</a></li>
<li><a href="/note/network-associate/layer3/pbr">PBR</a></li>
<li><a href="/note/network-associate/layer3/vrf">VRF</a></li>
</ul>
</li>
</ul>
</li>
</ul>

  </div>
</div>

<script src="/note/js/book-sidebar.js"></script>
      </div>

      <div class="column col-8 col-lg-12">
        <div class="book-content">
          <div class="book-navbar">
  <header class="navbar">
  <section class="navbar-section">
    <img class="navbar-icon" src="/note/shell.png">
  </section>
  <section class="navbar-center">
    kaiiiz/note
  </section>
  <section class="navbar-section">
    <label class="accordion-header c-hand" for="accordion-sidebar">
      <i class="icon icon-menu"></i>
    </label>
  </section>
</header>

<div class="accordion">
  <input type="checkbox" id="accordion-sidebar" name="accordion-checkbox" hidden>
  <div class="accordion-body">
    <ul>
<li><a href="/note">首頁</a></li>
<li><a href="/note/1072/sophomore">大二</a></li>
<li>大三</li>
<li>大四</li>
<li>英語相關
<ul>
<li><a href="/note/english-learning/grammar">文法</a></li>
</ul>
</li>
<li>網路相關
<ul>
<li><a href="/note/network-associate/landesign">LAN Design</a></li>
<li>Layer 2
<ul>
<li><a href="/note/network-associate/layer2/vlan">VLAN</a></li>
<li><a href="/note/network-associate/layer2/vtp">VTP</a></li>
<li><a href="/note/network-associate/layer2/stp">STP</a></li>
</ul>
</li>
<li>Layer 3
<ul>
<li><a href="/note/network-associate/layer3/routing">Routing</a></li>
<li><a href="/note/network-associate/layer3/vlsm">VLSM</a></li>
<li><a href="/note/network-associate/layer3/ospf">OSPF</a></li>
<li><a href="/note/network-associate/layer3/redistribution">Redistribution</a></li>
<li><a href="/note/network-associate/layer3/packet-switching">Packet Switching</a></li>
<li><a href="/note/network-associate/layer3/pbr">PBR</a></li>
<li><a href="/note/network-associate/layer3/vrf">VRF</a></li>
</ul>
</li>
</ul>
</li>
</ul>

  </div>
</div>
</div>

<div class="book-post">
  <h1 id="policy-based-routing">Policy-Based Routing</h1>
<p>當封包到達入境介面時，路由器的資料層邏輯會採取若干步驟處理封包。檢查訊框檢查碼(Frame Check Sequence, FCS)沒問題後，變會移除 L2 標頭標尾，留下 L3 的封包，最後比對目的地位址與路由表是否一致。</p>
<p>原則型路由(PBR)優先於預設的目標型轉送邏輯，當在解除封裝時，PBR會先攔截封包，接著路由器才去查詢 CEF 表。</p>
<p>PBR 透過 route-map 來選擇轉送封包的方式。</p>
<p><img src="2019-07-12-01-36-03.png" alt></p>
<p><code>route-map match</code>:</p>
<ul>
<li><code>match ip address</code>：參照到 ACL</li>
<li><code>match length {min} {max}</code>：指定長度範圍</li>
</ul>
<p>當封包符合 route-map，<code>set</code> 負責定義轉送封包所採取的動作。</p>
<ul>
<li><code>set ip next-hop {ip-address} [...{ip-address}]</code>
<ul>
<li>下一跳必須屬於直連網路</li>
</ul>
</li>
<li><code>set ip default next-hop {ip-address} [...{ip-address}]</code>
<ul>
<li>路由選擇會先試圖使用路由表轉送</li>
</ul>
</li>
<li><code>set interface {interface-type} {interface-number} [...{interface-type} {interface-number}]</code>
<ul>
<li>使用清單中第一個 up 介面轉送</li>
</ul>
</li>
<li><code>set default interface {interface-type} {interface-number} [...{interface-type} {interface-number}]</code>
<ul>
<li>路由選擇會先試圖使用路由表轉送</li>
</ul>
</li>
</ul>
<p>設定完 route-map 後，設定入境介面 <code>ip policy route-map {name}</code></p>
<blockquote>
<p>未加入 default：先試著用 PBR，再試著以標準方式轉送<br>
加入 default：先試著以標準方式轉送(不包括預設路徑)，再用 PBR</p>
</blockquote>
<h2 id="其他功能">其他功能</h2>
<h3 id="pbr適用本地建立的封包">PBR適用本地建立的封包</h3>
<p>路由器本身建立的封包不會透過某個介面進入路由器，可以設定 <code>ip local policy route-map {name}</code> 並參照 PBR 的 route-map 即可</p>
<h3 id="設定ip優先順序">設定IP優先順序</h3>
<p>為了區別不同層級的網路服務(可能要讓網路電話、網路視訊的封包有較低延遲)，必須區分不同類型的封包。</p>
<p>現行最常使用的QoS標記(QoS marking)方法是<strong>類別標記法(Class-Based Marking)</strong>，在過去，PBR是少數能夠使用這項重要的 QoS 標記封包的方法之一，然而大部分現今的 QoS 設計拿掉了 PBR 標記封包的功能。</p>
<blockquote>
<p>QoS: Quality of service</p>
</blockquote>
<p>多年來，IP 標頭最初定義的 ToS(Type of service) 位元組中的個別位元已經被定義為數種方法。其中一種定義是採用 ToS 位元組中最左邊的 3 個位元作為 IP 優先順序 (IP Precedence, IPP)，此欄位可以用於一般的 QoS 標記。一般來說，高的 IPP 會獲得較佳的 QoS 處置。</p>
<p>自 1990 年代，ToS 位元組即被重新定義為差異化服務位元組(Differential Services, DS)，且最左邊 6 個位元定義為差異化服務代碼點(Differential Service Code Point, DSCP)。大部分現行的 QoS 建置皆已 DSCP 欄位設定為主。</p>
<p>PBR 設定：</p>
<p><code>set ip precedence {value}</code></p>
<p><code>set ip tos {value}</code></p>
<h3 id="使用ip-sla的pbr">使用IP SLA的PBR</h3>
<p>PBR 亦可反應出某些 IP 網路健康狀況的動態監測，為此，PBR 需依賴 IP 服務等級協定 (IP Service-Level Agreement, IP SLA)。</p>
<p>簡而言之，如果 IP SLA 監測的效能沒有達到定義的臨界值，則 PBR 不使用特定的路徑。</p>
<h2 id="ip-sla">IP SLA</h2>
<p>IP SLA 可以持續監測網路的行為。監測方式就跟 ping 一樣，判斷設備的 IP 是否有所回應。</p>
<p>設定完後，路由器會收集運作的結果，並將統計資料存在 CISCO-RTTMON-MIB 中，然後管理應用程式就能夠從路由器的 MIB 收集資料，並根據這些資料回報是否符合企業的 SLA。</p>
<h3 id="運作原理">運作原理</h3>
<p>IP SLA 採用所謂的「運作」蓋念，每個運作定義了路由器所產生的封包類型、目的地和來源位址，以及封包的其他特性。可以配置的項目包括特定運作中路由器傳送封包的間隔、收集的統計資料類型…。</p>
<p><img src="2019-07-12-12-57-28.png" alt></p>
<p>當封包傳送到主機時，主機無須借助任何的特殊軟體或設定即可正常運作。只需要設定主機能認得的封包之運作類型。</p>
<h3 id="設定">設定</h3>
<p>IP SLA ICMP：</p>
<ol>
<li><code>ip sla {sla-ops-number}</code>：指派運作編號</li>
<li>(optional) <code>icmp-echo ...</code>：定義目的地IP位址或主機名稱</li>
<li>(optional) <code>frequency {seconds}</code>：定義傳送封包的頻率</li>
<li><code>ip sla schedule {sla-ops-number} ...</code>：排程 SLA 的執行時間</li>
</ol>
<p>檢驗：</p>
<p><code>show ip sla configuration</code></p>
<p><code>show ip sla statistics</code></p>
<h3 id="追蹤物件">追蹤物件</h3>
<p><img src="2019-07-12-13-05-02.png" alt="使用 IP SLA 設定路徑控制的參照關係"></p>
<p>追蹤物件查看 IP SLA 運作的 return code，來判斷追蹤的狀態為 up 或 down。</p>
<blockquote>
<p>Cisco IOS 使用追蹤物件的主要理由之一是為了防止路徑翻動(Route flapping)，追蹤物件提供了延遲設定，定義追蹤狀態變動之後的多少時間，才讓追蹤物件改變其狀態。</p>
</blockquote>
<h4 id="設定靜態路由追蹤ip-sla">設定靜態路由追蹤IP SLA</h4>
<ol>
<li><code>track {object-number} ip sla {sla-ops-number} [state|reachability]</code></li>
<li>(optional) <code>delay [down {seconds}|up {seconds}]</code></li>
<li><code>ip route {destination} {mask} [{interface}|{next-hop}] track {object-number}</code></li>
</ol>
<p>檢驗：</p>
<p><code>show track</code></p>
<h4 id="設定pbr追蹤ip-sla">設定PBR追蹤IP SLA</h4>
<p>修改 route-map 的 set 命令</p>
<p><code>set ip next-hop verify-avalibility ... track 2</code></p>
<p>當追蹤物件為 up，PBR 就會照著設定運作，當追蹤物件為 down，PBR 便不會使用 set 命令，而是依照標準型路由程序來轉送封包。</p>

</div>


  <div class="book-comments">
    
    <div id="disqus_thread"></div>
    <script>
    (function() { // DON'T EDIT BELOW THIS LINE
    var d = document, s = d.createElement('script');
    s.src = 'https://at881005.disqus.com/embed.js';
    s.setAttribute('data-timestamp', +new Date());
    (d.head || d.body).appendChild(s);
    })();
    </script>
    <noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>



  </div>


<script src="/note/js/book-post.js"></script>
        </div>
      </div>

      <div class="column col-2 hide-lg">
        <div class="book-toc">
  <div class="book-tocbot">
  </div>
  <div class="book-tocbot-menu">
    <a class="book-toc-expand" onclick="expand_toc()">Expand all</a>
    <a onclick="go_top()">Back to top</a>
    <a onclick="go_bottom()">Go to bottom</a>
  </div>
</div>

<script>
tocbot.init({
  tocSelector: '.book-tocbot',
  contentSelector: '.book-post',
  headingSelector: 'h1, h2, h3, h4, h5',
  collapseDepth: 2,
  orderedList: false,
  scrollSmooth: false,
});

function expand_toc(){
  var b = document.querySelector(".book-toc-expand");
  tocbot.init({
    tocSelector: '.book-tocbot',
    contentSelector: '.book-post',
    headingSelector: 'h1, h2, h3, h4, h5',
    collapseDepth: 6,
    orderedList: false,
    scrollSmooth: false,
  });
  b.setAttribute("onclick", "collapse_toc()");
  b.innerHTML = "Collapse all"
}

function collapse_toc(){
  var b = document.querySelector(".book-toc-expand");
  tocbot.init({
    tocSelector: '.book-tocbot',
    contentSelector: '.book-post',
    headingSelector: 'h1, h2, h3, h4, h5',
    collapseDepth: 2,
    orderedList: false,
    scrollSmooth: false,
  });
  b.setAttribute("onclick", "expand_toc()");
  b.innerHTML = "Expand all"
}

function go_top() {
  window.scrollTo(0, 0);
}

function go_bottom() {
  window.scrollTo(0, document.body.scrollHeight);
}

</script>
      </div>
    </div>
  </div>
</div>

</body>
</html>
