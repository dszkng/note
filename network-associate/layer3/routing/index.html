<!DOCTYPE html>
<html lang="">

<head><meta name="generator" content="Hexo 3.8.0">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1.0, user-scalable=no">

    
      <link rel="icon" href="/note/shell.png">
    

    <title>
        
          kaiiiz/note
        
    </title>

    <!-- Spectre.css framework (v0.5.8) -->
    <link rel="stylesheet" href="https://unpkg.com/spectre.css/dist/spectre.min.css">
    <link rel="stylesheet" href="https://unpkg.com/spectre.css/dist/spectre-exp.min.css">
    <link rel="stylesheet" href="https://unpkg.com/spectre.css/dist/spectre-icons.min.css">

    <!-- Noto Sans TC -->
    <link href="https://fonts.googleapis.com/css?family=Noto+Sans+TC" rel="stylesheet">

    <!-- theme css & js -->
    <link rel="stylesheet" href="/note/css/spectre_custom.css">
    <link rel="stylesheet" href="/note/css/book.css">
    <script src="/note/js/book.js"></script>

    <!-- tocbot -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tocbot/4.4.2/tocbot.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/tocbot/4.4.2/tocbot.css">

    <!-- highlight.js -->
    <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.15.6/styles/default.min.css">
    <script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.15.6/highlight.min.js"></script>
    <script>hljs.initHighlightingOnLoad();</script>
    
    <!-- katex -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.10.0/katex.min.css">

    
<!-- Google Analytics -->
<script>
(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
})(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

ga('create', 'UA-112717568-2', 'auto');
ga('send', 'pageview');
</script>
<!-- End Google Analytics -->

</head>

<body>

<div class="container">
  <div class="book-container">
    <div class="columns">
      <div class="column col-2 hide-lg">
        <div class="book-sidebar">
  <h4 class="site-meta">
    <a href="/note/">kaiiiz/note</a>
  </h4>
  <div class="sidebar-content">
    <ul>
<li><a href="/note">首頁</a></li>
<li><a href="/note/1072/sophomore">大二</a></li>
<li>大三</li>
<li>大四</li>
<li>英語相關
<ul>
<li><a href="/note/english-learning/grammar">文法</a></li>
</ul>
</li>
<li>網路相關
<ul>
<li><a href="/note/network-associate/landesign">LAN Design</a></li>
<li>Layer 2
<ul>
<li><a href="/note/network-associate/layer2/vlan">VLAN</a></li>
<li><a href="/note/network-associate/layer2/vtp">VTP</a></li>
<li><a href="/note/network-associate/layer2/stp">STP</a></li>
</ul>
</li>
<li>Layer 3
<ul>
<li><a href="/note/network-associate/layer3/routing">Routing</a></li>
<li><a href="/note/network-associate/layer3/vlsm">VLSM</a></li>
<li><a href="/note/network-associate/layer3/ospf">OSPF</a></li>
<li><a href="/note/network-associate/layer3/redistribution">Redistribution</a></li>
<li><a href="/note/network-associate/layer3/packet-switching">Packet Switching</a></li>
<li><a href="/note/network-associate/layer3/pbr">PBR</a></li>
<li><a href="/note/network-associate/layer3/vrf">VRF</a></li>
</ul>
</li>
</ul>
</li>
</ul>

  </div>
</div>

<script src="/note/js/book-sidebar.js"></script>
      </div>

      <div class="column col-8 col-lg-12">
        <div class="book-content">
          <div class="book-navbar">
  <header class="navbar">
  <section class="navbar-section">
    <img class="navbar-icon" src="/note/shell.png">
  </section>
  <section class="navbar-center">
    kaiiiz/note
  </section>
  <section class="navbar-section">
    <label class="accordion-header c-hand" for="accordion-sidebar">
      <i class="icon icon-menu"></i>
    </label>
  </section>
</header>

<div class="accordion">
  <input type="checkbox" id="accordion-sidebar" name="accordion-checkbox" hidden>
  <div class="accordion-body">
    <ul>
<li><a href="/note">首頁</a></li>
<li><a href="/note/1072/sophomore">大二</a></li>
<li>大三</li>
<li>大四</li>
<li>英語相關
<ul>
<li><a href="/note/english-learning/grammar">文法</a></li>
</ul>
</li>
<li>網路相關
<ul>
<li><a href="/note/network-associate/landesign">LAN Design</a></li>
<li>Layer 2
<ul>
<li><a href="/note/network-associate/layer2/vlan">VLAN</a></li>
<li><a href="/note/network-associate/layer2/vtp">VTP</a></li>
<li><a href="/note/network-associate/layer2/stp">STP</a></li>
</ul>
</li>
<li>Layer 3
<ul>
<li><a href="/note/network-associate/layer3/routing">Routing</a></li>
<li><a href="/note/network-associate/layer3/vlsm">VLSM</a></li>
<li><a href="/note/network-associate/layer3/ospf">OSPF</a></li>
<li><a href="/note/network-associate/layer3/redistribution">Redistribution</a></li>
<li><a href="/note/network-associate/layer3/packet-switching">Packet Switching</a></li>
<li><a href="/note/network-associate/layer3/pbr">PBR</a></li>
<li><a href="/note/network-associate/layer3/vrf">VRF</a></li>
</ul>
</li>
</ul>
</li>
</ul>

  </div>
</div>
</div>

<div class="book-post">
  <h1 id="routing">Routing</h1>
<p>路由器在路由表中新增路徑主要有 3 種方式：</p>
<ol>
<li>直連路徑</li>
<li>靜態路由</li>
<li>動態路由協定</li>
</ol>
<h2 id="路由運作模式">路由運作模式</h2>
<p>傳送封包前，比對自己和要傳送的封包的 IP 與 Netmask</p>
<ol>
<li>如果在相同子網路，則傳送到目的主機，並透過 ARP 來尋找目的主機的 MAC Address</li>
<li>如果不在同個子網路，則傳送到 default gateway，並透過 ARP 來尋找 default gateway 的 MAC Address</li>
</ol>
<p>路由器的運作步驟：</p>
<ol>
<li>檢查傳送過來的每個訊框的<strong>訓框檢查碼</strong>(Frame Check Sequence, FCS)，如果發生錯誤則丟棄該訊框</li>
<li>檢查目的位址，若為路由器的位址或是廣播/群播位址，則會繼續處理</li>
<li>將訊框的標頭標尾丟棄，留下 IP 封包</li>
<li>查看路由表，尋找與目的地 IP 位址相符的路徑</li>
<li>決定封包傳送到下一台路由器或是目的主機</li>
<li>把 IP 封包封裝到新的 L2 標頭與標尾，將訊框從合適的介面傳出</li>
</ol>
<p><img src="2019-05-13-23-10-51.png" alt="PC1 傳送封包到 PC3"></p>
<p>WAN 鏈路與 LAN 鏈路運作方法大致相同，但點對點鏈路不需要 ARP 表，因為最多只有一台路由器連接到它，因此可以省略 L2 的定址。然而使用訊框中繼時，路由程序需要 L2 的位址，稱為 <strong>資料鏈結識別碼</strong> (Data-link Connection Identifier, DLCI) (會在之後提到)</p>
<p><img src="2019-05-13-23-16-13.png" alt></p>
<h2 id="ip-subnet">IP/Subnet</h2>
<ul>
<li>每個 IP 屬於 A, B 或 C 級網路 (分級式IP網路)</li>
<li>子網路用十進位 (e.g. 255.255.255.0) 或首碼表示 (e.g. /24)</li>
<li>相同 Subnet 的設備應使用相同 Netmask，否則會對路由造成錯誤的判斷</li>
<li>相同 VLAN 應在相同 Subnet</li>
</ul>
<p><img src="2019-05-13-23-25-55.png" alt></p>
<h2 id="longest-prefix-match">Longest Prefix Match</h2>
<p>當路由表的 Subnet 發生重疊時：</p>
<ul>
<li>使用自動彙整</li>
<li>手動彙整路徑</li>
<li>使用靜態路由</li>
<li>不正確的子網路切割設計，導致子網路位址範圍的重疊</li>
</ul>
<p>路由表會使用 <strong>最精確的路徑</strong> (首碼最長的路徑)，舉例來說：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">R1# show ip route rip</span><br><span class="line">...</span><br><span class="line">172.16.1.1/32 via 172.16.25.2</span><br><span class="line">172.16.1.0/24 via 172.16.25.129</span><br><span class="line">172.16.0.0/24 via 172.16.25.2</span><br><span class="line">172.16.0.0/16 via 172.16.25.129</span><br><span class="line">0.0.0.0/0 via 172.16.25.129</span><br><span class="line">...</span><br></pre></td></tr></table></figure>
<p>則</p>
<p>172.16.1.1：與 5 條都相符，首碼最長到 /32，所以走 172.16.1.1/32<br>
172.16.1.2：與 4 條都相符，首碼最長到 /24，所以走 172.16.1.0/24<br>
172.16.2.3：與 3 條都相符，首碼最長到 /22，所以走 172.16.0.0/22<br>
172.16.4.3：與 2 條都相符，首碼最長到 /16，所以走 172.16.0.0/16</p>
<h2 id="切割與mtu">切割與MTU</h2>
<p>TCP/IP 為 IP 封包定義一個最大長度，稱為 <strong>最大傳輸單元</strong> (MTU)，MTU 長度視設定和介面功能而定，預設情況，電腦根據 L2 訊框的資料部分的最大長度來計算介面的 MTU，例如乙太網路的預設 MTU 為 1500</p>
<p>路由器與所有 IP 主機相同，如果封包超過 MTU，路由器就不能透過介面轉送封包，因此需要透過 <strong>切割</strong>，將封包分成數個不超過 MTU 的封包</p>
<p><img src="2019-05-13-23-47-55.png" alt="HDLC(High-level Data Link Control)，高階資料鏈結控制協定支援最大的 MTU 為 1000"></p>
<p>IP 標頭包含一個 ID 值 (切割後每個封包的 ID 值相同) 和一個偏移值 (定義切割後的封包在原始封包的位置)，透過偏移欄位可以依序重組回原封包</p>
<h2 id="直連網路">直連網路</h2>
<h3 id="secondary-ip-address">Secondary IP Address</h3>
<p>Secondary IP Address 是在相同的資料鏈結中使用多個網路或子網路。透過在同一介面上使用多個子網路，增加可用 IP 位址的數量。為此，在每一個子網路中，路由器都需要一個 IP 位址，以便子網路下的機器有 default gateway。</p>
<p><img src="2019-05-13-23-56-53.png" alt="10.1.2.0 與 10.1.7.0 可以在同一個乙太網路中使用"></p>
<p>缺點：LAN 中主機 Routing 效率較低。若 10.1.2.0 要傳給 10.1.7.0 中需要過 Router 再下去</p>
<h3 id="zero-subnet">Zero Subnet</h3>
<p>Zero subnet 是每個分級式網路的其中一個子網路，二進制子網路編號中的子網路部分均為 0。以十進制表示時，Zero subnet 與分級式網路的編號相同。設定 <code>no ip subnet-zero</code> 後，路由器即拒絕任何使用 zero-subnet 的 <code>ip address</code> 指令。</p>
<h3 id="isl-802-1q">ISL &amp; 802.1Q</h3>
<p><img src="2019-05-14-00-13-13.png" alt></p>
<p>路由器的 Fa0/0 可以透過建立 3 個 Subinterface，每個 Subinterface 上分配一個 IP 及 VLAN (<code>encapsulation &lt;protocol&gt; &lt;vlan-id&gt;</code>)，來連接 Switch 上的 Trunk link</p>
<h2 id="靜態路由">靜態路由</h2>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">(config)# ip route 192.168.1.0 255.255.255.0 192.168.12.2</span><br><span class="line"># sh ip route</span><br></pre></td></tr></table></figure>
<h3 id="default-route">Default route</h3>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">(config)# ip route 0.0.0.0 0.0.0.0 &lt;next-hop&gt;</span><br></pre></td></tr></table></figure>
<p>或</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">(config)# ip default-network &lt;next-number&gt;</span><br></pre></td></tr></table></figure>
<h2 id="分級與無級式遶送">分級與無級式遶送</h2>
<table>
<thead>
<tr>
<th></th>
<th>分級式(只看懂A,B,C級網路)</th>
<th>無級式</th>
</tr>
</thead>
<tbody>
<tr>
<td>位址</td>
<td>分為: 網路、子網路、主機</td>
<td>分為子網路、主機</td>
</tr>
<tr>
<td>遶送協定</td>
<td>不支援遮罩，不支援 VLSM</td>
<td>通告遮罩、支援 VLSM</td>
</tr>
<tr>
<td>遶送</td>
<td>受預設路徑使用方式的限制</td>
<td>不受預設路徑使用方式限制</td>
</tr>
</tbody>
</table>

</div>


  <div class="book-comments">
    
    <div id="disqus_thread"></div>
    <script>
    (function() { // DON'T EDIT BELOW THIS LINE
    var d = document, s = d.createElement('script');
    s.src = 'https://at881005.disqus.com/embed.js';
    s.setAttribute('data-timestamp', +new Date());
    (d.head || d.body).appendChild(s);
    })();
    </script>
    <noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>



  </div>


<script src="/note/js/book-post.js"></script>
        </div>
      </div>

      <div class="column col-2 hide-lg">
        <div class="book-toc">
  <div class="book-tocbot">
  </div>
  <div class="book-tocbot-menu">
    <a class="book-toc-expand" onclick="expand_toc()">Expand all</a>
    <a onclick="go_top()">Back to top</a>
    <a onclick="go_bottom()">Go to bottom</a>
  </div>
</div>

<script>
tocbot.init({
  tocSelector: '.book-tocbot',
  contentSelector: '.book-post',
  headingSelector: 'h1, h2, h3, h4, h5',
  collapseDepth: 2,
  orderedList: false,
  scrollSmooth: false,
});

function expand_toc(){
  var b = document.querySelector(".book-toc-expand");
  tocbot.init({
    tocSelector: '.book-tocbot',
    contentSelector: '.book-post',
    headingSelector: 'h1, h2, h3, h4, h5',
    collapseDepth: 6,
    orderedList: false,
    scrollSmooth: false,
  });
  b.setAttribute("onclick", "collapse_toc()");
  b.innerHTML = "Collapse all"
}

function collapse_toc(){
  var b = document.querySelector(".book-toc-expand");
  tocbot.init({
    tocSelector: '.book-tocbot',
    contentSelector: '.book-post',
    headingSelector: 'h1, h2, h3, h4, h5',
    collapseDepth: 2,
    orderedList: false,
    scrollSmooth: false,
  });
  b.setAttribute("onclick", "expand_toc()");
  b.innerHTML = "Expand all"
}

function go_top() {
  window.scrollTo(0, 0);
}

function go_bottom() {
  window.scrollTo(0, document.body.scrollHeight);
}

</script>
      </div>
    </div>
  </div>
</div>

</body>
</html>
